# Batch process many image pairs
name: summary_statistics
run-name: summary_statistics

on:
  workflow_dispatch:
  workflow_call:

jobs:
  summary_statistics:
    name: summary_statistics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Conda environment with Micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          cache-environment: true
          # Fixed path: pointed to root directory
          environment-file: environment.yml
          environment-name: image-correlation

      - name: Download Velocity Map Artifacts
        uses: actions/download-artifact@v4
        with:
          # Fixed path: artifacts downloaded to the main folder where script expects them
          path: .
          merge-multiple: true
                
      - name: Compute Summary Statistics
        # Added explicit shell call here to ensure environment is active
        shell: bash -el {0}
        run: |
          # Fixed path: running script from the root folder
          python summary_statistics.py

      - name: Upload Summary Statistics Figure as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: summary_statistics
          path: |
            # Fixed path: looking for the output image in the root folder
            velocity_summary_statistics.png
